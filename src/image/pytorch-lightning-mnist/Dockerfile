ARG PYTORCH_VERSION=1.13.1
ARG PYTORCH_ARCH=cpu

FROM kaenai/pytorch:${PYTORCH_VERSION}-${PYTORCH_ARCH}-runtime

ARG KAEN_WORLD_SIZE
ENV KAEN_WORLD_SIZE=${KAEN_WORLD_SIZE:-1}

ARG KAEN_NPROC_PER_NODE
ENV KAEN_NPROC_PER_NODE=${KAEN_NPROC_PER_NODE:-1}

ARG KAEN_RANK
ENV KAEN_RANK=${KAEN_RANK:-0}

ARG KAEN_JOB_MANAGER_HOST
ENV KAEN_JOB_MANAGER_HOST=${KAEN_JOB_MANAGER_HOST:-localhost}

ARG KAEN_JOB_MANAGER_PORT
ENV KAEN_JOB_MANAGER_PORT=${KAEN_JOB_MANAGER_PORT:-23400}

RUN pip install pytorch_lightning

COPY main.sh /workspace
COPY main.py /workspace

RUN chmod +x main.sh

WORKDIR /workspace
ENTRYPOINT [ "/bin/bash", "-l", "-c" ]
# ENTRYPOINT ["./main.sh"]
# CMD ["main.py"]
